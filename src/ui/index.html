<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FaceTrack IoT Dashboard</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a1a; color: #fff; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        .video-box { background: #000; border-radius: 8px; overflow: hidden; height: 600px; display: flex; align-items: center; justify-content: center; border: 1px solid #333; }
        .video-box img { width: 100%; height: 100%; object-fit: contain; }
        .sidebar { background: #2d2d2d; padding: 20px; border-radius: 8px; height: fit-content; }
        h1 { margin-top: 0; color: #4CAF50; }
        .status-item { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #444; }
        .status-label { font-size: 0.9em; color: #aaa; }
        .status-value { font-size: 1.2em; font-weight: bold; margin-top: 5px; }
        .log-box { height: 300px; overflow-y: auto; background: #222; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 0.9em; margin-top: 20px; }
        .log-entry { margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .ts { color: #888; margin-right: 10px; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body>
    <div class="container">
        <div>
            <h1>FaceTrack IoT Dashboard</h1>
            <div class="video-box">
                <img id="videoFeed" src="/video_feed" alt="Waiting for stream..." onerror="this.style.display='none'">
                <div id="noStream" style="display:none; color: #666;">Stream Offline</div>
            </div>
        </div>
        <div class="sidebar">
            <div class="status-item">
                <div class="status-label">System Status</div>
                <div class="status-value" id="status" style="color: #ff9800">Connecting...</div>
            </div>
            <div class="status-item">
                <div class="status-label">Locked Target</div>
                <div class="status-value" id="target">None</div>
            </div>
            <div class="status-item">
                <div class="status-label">Servo Action</div>
                <div class="status-value" id="servo">Idle</div>
            </div>
            <div class="status-item">
                <div class="status-label">FPS</div>
                <div class="status-value" id="fps">0.0</div>
            </div>
            <h3>Activity Log</h3>
            <div class="log-box" id="logBox"></div>
        </div>
    </div>

    <script>
        const socket = io();
        const logBox = document.getElementById('logBox');
        
        function addLog(msg) {
            const div = document.createElement('div');
            div.className = 'log-entry';
            const time = new Date().toLocaleTimeString();
            div.innerHTML = `<span class="ts">[${time}]</span> ${msg}`;
            logBox.insertBefore(div, logBox.firstChild);
            if (logBox.children.length > 50) logBox.lastChild.remove();
        }

        socket.on('connect', () => {
            document.getElementById('status').innerText = 'Connected';
            document.getElementById('status').style.color = '#4CAF50';
            addLog('Connected to Server');
        });

        socket.on('disconnect', () => {
            document.getElementById('status').innerText = 'Disconnected';
            document.getElementById('status').style.color = '#f44336';
            addLog('Disconnected from Server');
        });

        socket.on('status_update', (data) => {
            if (data.target) document.getElementById('target').innerText = data.target;
            if (data.locked !== undefined) {
                document.getElementById('target').style.color = data.locked ? '#4CAF50' : '#aaa';
                document.getElementById('target').innerText = data.locked ? (data.target || 'Locked') : 'Searching...';
            }
            if (data.fps) document.getElementById('fps').innerText = parseFloat(data.fps).toFixed(1);
            if (data.action) document.getElementById('servo').innerText = data.action;
        });

        socket.on('log', (data) => {
            addLog(data.msg);
        });
        
        // Handle video feed error
        const img = document.getElementById('videoFeed');
        img.onerror = () => {
            img.style.display = 'none';
            document.getElementById('noStream').style.display = 'block';
        };
        img.onload = () => {
            img.style.display = 'block';
            document.getElementById('noStream').style.display = 'none';
        };
    </script>
</body>
</html>
